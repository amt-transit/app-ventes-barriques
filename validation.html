<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation des Ventes - AMT</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        .kpi-stock-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .card-stock { border-radius: 12px; padding: 12px; text-align: center; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .bg-blue { background: #1877f2; } .bg-green { background: #10b981; } .bg-red { background: #be123c; }
        .stock-label { font-size: 9px; text-transform: uppercase; font-weight: bold; opacity: 0.9; }
        .stock-number { font-size: 16px; font-weight: bold; display: block; margin-top: 5px; }
        .form-section { background: #f8fafc; padding: 15px; border-radius: 10px; border: 2px solid #e2e8f0; margin-bottom: 20px; }
        .dashboard-grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; font-size: 12px; min-width: 400px; }
        th, td { padding: 10px; border: 1px solid #e2e8f0; text-align: left; }

        /* Styles pour les listes de session */
        .temp-list { margin-top: 10px; border: 1px dashed #64748b; border-radius: 8px; padding: 8px; background: #ffffff; display: none; }
        .btn-add-item { background: #1e293b; color: white; border: none; border-radius: 5px; padding: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 5px; font-size: 11px; }
        .btn-remove { color: #be123c; cursor: pointer; font-weight: bold; border: none; background: none; }
        
        .section-ventes { border-left: 5px solid #1877f2; padding-left: 10px; margin-bottom: 20px; }
        .section-consos { border-left: 5px solid #64748b; padding-left: 10px; margin-bottom: 20px; }
        .section-retours { border-left: 5px solid #f59e0b; padding-left: 10px; margin-bottom: 20px; }

        @media (max-width: 850px) {
            .app-header { display: flex; flex-direction: column; align-items: center; }
            .dashboard-grid-2-col { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <img src="logo.png" alt="Logo" class="app-logo">
        <h1>Validation & Encaissement</h1>
    </header>

    <nav class="navigation">
        <a href="validation.html" class="active">Validation</a>
        <a href="stock.html">Stock</a>
        <a href="dashboard.html">Tableau de Bord</a>
        <a href="tresorerie.html">Tr√©sorerie</a>
        <a href="history.html">Historique</a>
        <a href="utilisateurs.html">Utilisateurs</a>
        <a href="recuperation.html">R√©cup√©ration</a>
        <button onclick="logout()" class="logout-button">D√©connexion</button>
    </nav>

    <div class="dashboard-grid-2-col" style="padding: 15px;">
        <div class="form-section">
            <h2 style="color: #1877f2; font-size: 15px; margin-top:0;">üìù Saisie group√©e des donn√©es</h2>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <input type="date" id="valDate" style="padding:10px; width:100%; box-sizing:border-box;">
                <select id="valVendeur" style="padding:10px; width:100%;"></select>

                <div class="section-ventes">
                    <p style="font-size: 10px; font-weight: bold; color: #1877f2;">üì¶ √âTAPE 1 : VENTES CLIENTS</p>
                    <select id="valProduit" style="padding:10px; width:100%; margin-bottom:5px;"></select>
                    <div id="sellerStockInfo" style="font-size: 10px; color: #1877f2; font-weight: bold; margin-bottom:5px;"></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="valQuantite" placeholder="Qt√©">
                        <input type="number" id="valPrixUnit" placeholder="Prix" readonly style="background:#f1f5f9; padding:10px;">
                    </div>
                    <button class="btn-add-item" onclick="ajouterItem('ventes')">Ajouter Vente ‚ûï</button>
                    <div id="list-ventes" class="temp-list">
                        <table style="width:100%; font-size:10px; margin:0;">
                            <thead><tr style="background:#e0efff;"><th>Produit</th><th>Qt√©</th><th>Total</th><th></th></tr></thead>
                            <tbody id="body-ventes"></tbody>
                        </table>
                    </div>
                </div>

                <div class="section-consos">
                    <p style="font-size: 10px; font-weight: bold; color: #64748b;">üõ†Ô∏è √âTAPE 2 : USAGE INTERNE (FOURNITURES)</p>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                        <select id="valProduitConso" style="padding:10px;"></select>
                        <input type="number" id="valQuantiteConso" placeholder="Qt√©">
                    </div>
                    <button class="btn-add-item" onclick="ajouterItem('consos')">Ajouter Usage ‚ûï</button>
                    <div id="list-consos" class="temp-list">
                        <table style="width:100%; font-size:10px; margin:0;">
                            <thead><tr style="background:#f1f5f9;"><th>Fourniture</th><th>Qt√©</th><th></th></tr></thead>
                            <tbody id="body-consos"></tbody>
                        </table>
                    </div>
                </div>

                <div class="section-retours">
                    <p style="font-size: 10px; font-weight: bold; color: #1e293b;">üîÑ √âTAPE 3 : RETOURS DE COLIS</p>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                        <select id="valProduitRetour" style="padding:10px;"></select>
                        <input type="number" id="valQuantiteRetour" placeholder="Qt√©">
                    </div>
                    <button class="btn-add-item" onclick="ajouterItem('retours')">Ajouter Retour ‚ûï</button>
                    <div id="list-retours" class="temp-list">
                        <table style="width:100%; font-size:10px; margin:0;">
                            <thead><tr style="background:#fff7ed;"><th>Produit</th><th>Qt√©</th><th></th></tr></thead>
                            <tbody id="body-retours"></tbody>
                        </table>
                    </div>
                </div>

                <div style="background: #f0fdf4; padding: 10px; border-radius: 8px; border: 1px solid #bbf7d0;">
                    <p style="font-size: 10px; font-weight: bold; color: #166534; margin: 0 0 5px 0;">üí∞ √âTAPE 4 : ARGENT RE√áU</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="valAcompte" placeholder="Montant (‚Ç¨)" style="padding:10px;">
                        <input type="number" id="valRemise" value="0" style="padding:10px;">
                    </div>
                </div>

                <div style="background: #fdf4ff; padding: 10px; border-radius: 8px; border: 1px solid #f5d0fe;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="valPayAbidjan" style="width: 18px; height: 18px; cursor: pointer;">
                        <label style="font-size: 12px; font-weight:bold;">Pay√© √† Abidjan</label>
                    </div>
                    <input type="text" id="valClientRef" placeholder="Nom/R√©f√©rence Client" style="display:none; width:100%; padding:10px; margin-top:5px; border-radius:5px; border:1px solid #f5d0fe;">
                </div>

                <button id="btnConfirmerVente" style="background:#1877f2; height:50px; border:none; border-radius:8px; color:white; font-weight:bold; cursor:pointer;">ENREGISTRER TOUTE LA SESSION</button>
            </div>
        </div>

        <div>
            <div class="kpi-stock-grid">
                <div class="card-stock bg-blue"><span class="stock-label">Vendu Agence</span><span id="totalDu" class="stock-number">0‚Ç¨</span></div>
                <div class="card-stock bg-green"><span class="stock-label">Encaiss√©</span><span id="totalPaye" class="stock-number">0‚Ç¨</span></div>
                <div class="card-stock bg-red" style="grid-column: span 2;"><span class="stock-label">Dette Vendeur</span><span id="resteAPayer" class="stock-number">0‚Ç¨</span></div>
            </div>
            <div class="table-responsive">
                <table id="sellerInventoryTable">
                    <thead><tr style="background: #f1f5f9;"><th>Produit</th><th>Pris</th><th>Vendu</th><th>üõ†Ô∏è Conso.</th><th>Rendu</th><th>En main</th></tr></thead>
                    <tbody id="sellerInventoryBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCV8hR9MxIdpZDthtQpMbByZtNet1nIO-M", authDomain: "app-ventes-barriques.firebaseapp.com", projectId: "app-ventes-barriques", storageBucket: "app-ventes-barriques.appspot.com", messagingSenderId: "615546459847", appId: "1:615546459847:web:1b387b0b703b7a9a1210e2" };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        window.db = firebase.firestore();
    </script>
    <script src="auth-guard.js"></script>

    <script>
        const valVendeur = document.getElementById('valVendeur');
        const valPayAbidjan = document.getElementById('valPayAbidjan');
        const valClientRef = document.getElementById('valClientRef');
        
        let inventoryData = {}; 
        let globalPrices = {};
        
        // TABLEAUX DE SESSION (PANIER)
        let sessionVentes = [];
        let sessionConsos = [];
        let sessionRetours = [];

        function formatEUR(n) { return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(n || 0); }

        // --- GESTION DU PANIER MULTIPLE ---
        function ajouterItem(type) {
            let prod, qty, pu = 0;
            
            if (type === 'ventes') {
                prod = document.getElementById('valProduit').value;
                qty = parseInt(document.getElementById('valQuantite').value);
                pu = parseFloat(document.getElementById('valPrixUnit').value);
            } else if (type === 'consos') {
                prod = document.getElementById('valProduitConso').value;
                qty = parseInt(document.getElementById('valQuantiteConso').value);
            } else {
                prod = document.getElementById('valProduitRetour').value;
                qty = parseInt(document.getElementById('valQuantiteRetour').value);
            }

            if (!prod || isNaN(qty) || qty <= 0) return alert("Saisie invalide.");

            // V√©rification du stock restant "En main"
            const it = inventoryData[prod];
            const enMain = it ? it.pT - it.vT - it.rT - it.cT : 0;
            
            // On calcule combien on a d√©j√† ajout√© au panier pour ce produit
            const dejaDansPanier = (sessionVentes.filter(v => v.p === prod).reduce((s,v)=>s+v.q,0)) + 
                                  (sessionConsos.filter(c => c.p === prod).reduce((s,c)=>s+c.q,0)) + 
                                  (sessionRetours.filter(r => r.p === prod).reduce((s,r)=>s+r.q,0));

            if ((qty + dejaDansPanier) > enMain) return alert(`Action impossible. Le vendeur n'a que ${enMain} colis de ce type en main.`);

            if (type === 'ventes') sessionVentes.push({ p: prod, q: qty, pu: pu, t: qty * pu });
            else if (type === 'consos') sessionConsos.push({ p: prod, q: qty });
            else sessionRetours.push({ p: prod, q: qty });

            // Reset inputs
            if (type === 'ventes') document.getElementById('valQuantite').value = "";
            else if (type === 'consos') document.getElementById('valQuantiteConso').value = "";
            else document.getElementById('valQuantiteRetour').value = "";

            renderLists();
        }

        function renderLists() {
            // Rendu Ventes
            const bV = document.getElementById('body-ventes'); bV.innerHTML = "";
            document.getElementById('list-ventes').style.display = sessionVentes.length > 0 ? "block" : "none";
            sessionVentes.forEach((v, i) => { bV.innerHTML += `<tr><td>${v.p}</td><td>${v.q}</td><td>${v.t}‚Ç¨</td><td><button class="btn-remove" onclick="supprSession('ventes', ${i})">‚ùå</button></td></tr>`; });

            // Rendu Consos
            const bC = document.getElementById('body-consos'); bC.innerHTML = "";
            document.getElementById('list-consos').style.display = sessionConsos.length > 0 ? "block" : "none";
            sessionConsos.forEach((c, i) => { bC.innerHTML += `<tr><td>${c.p}</td><td>${c.q}</td><td><button class="btn-remove" onclick="supprSession('consos', ${i})">‚ùå</button></td></tr>`; });

            // Rendu Retours
            const bR = document.getElementById('body-retours'); bR.innerHTML = "";
            document.getElementById('list-retours').style.display = sessionRetours.length > 0 ? "block" : "none";
            sessionRetours.forEach((r, i) => { bR.innerHTML += `<tr><td>${r.p}</td><td>${r.q}</td><td><button class="btn-remove" onclick="supprSession('retours', ${i})">‚ùå</button></td></tr>`; });
        }

        window.supprSession = (type, index) => {
            if (type === 'ventes') sessionVentes.splice(index, 1);
            else if (type === 'consos') sessionConsos.splice(index, 1);
            else sessionRetours.splice(index, 1);
            renderLists();
        };

        // --- LOGIQUE FIRESTORE ET CALCULS ---
        async function loadPrices() {
            const snap = await db.collection("stocks").get();
            snap.forEach(doc => { if (doc.data().produit) globalPrices[doc.data().produit] = parseFloat(doc.data().prixVente) || 0; });
        }

        async function loadSellerData() {
            const name = valVendeur.value; if (!name) return;
            const [rSnap, vSnap, eSnap, retSnap, cSnap] = await Promise.all([
                db.collection("recuperations").where("vendeur", "==", name).get(),
                db.collection("ventes").where("vendeur", "==", name).get(),
                db.collection("encaissements_vendeurs").where("vendeur", "==", name).get(),
                db.collection("retours_vendeurs").where("vendeur", "==", name).get(),
                db.collection("consommations").where("vendeur", "==", name).get()
            ]);
            inventoryData = {};
            let hVendu = 0, hPaye = 0;
            rSnap.forEach(doc => { const d = doc.data(); if (!inventoryData[d.produit]) inventoryData[d.produit] = { pT:0, vT:0, rT:0, cT:0 }; inventoryData[d.produit].pT += d.quantite; });
            vSnap.forEach(doc => { 
                const d = doc.data(); if (!inventoryData[d.produit]) inventoryData[d.produit] = { pT:0, vT:0, rT:0, cT:0 }; inventoryData[d.produit].vT += d.quantite;
                if (globalPrices[d.produit] > 0 && d.payeAbidjan !== true) hVendu += (d.total || 0);
            });
            cSnap.forEach(doc => { const d = doc.data(); if (!inventoryData[d.produit]) inventoryData[d.produit] = { pT:0, vT:0, rT:0, cT:0 }; inventoryData[d.produit].cT += d.quantite; });
            retSnap.forEach(doc => { const d = doc.data(); if (!inventoryData[d.produit]) inventoryData[d.produit] = { pT:0, vT:0, rT:0, cT:0 }; inventoryData[d.produit].rT += d.quantite; });
            eSnap.forEach(doc => { const d = doc.data(); hPaye += (d.montantRecu || 0) + (d.remise || 0); });

            document.getElementById('resteAPayer').innerText = (hVendu - hPaye).toFixed(2) + "‚Ç¨";
            renderUI();
        }

        function renderUI() {
            document.querySelectorAll('select[id^="valProduit"]').forEach(s => s.innerHTML = '<option value="">-- Choisir --</option>');
            const tbody = document.getElementById('sellerInventoryBody'); tbody.innerHTML = '';
            for (const p in inventoryData) {
                const i = inventoryData[p]; const enMain = i.pT - i.vT - i.rT - i.cT;
                if (enMain > 0) {
                    document.getElementById('valProduit').innerHTML += `<option value="${p}">${p}</option>`;
                    document.getElementById('valProduitRetour').innerHTML += `<option value="${p}">${p}</option>`;
                    document.getElementById('valProduitConso').innerHTML += `<option value="${p}">${p}</option>`;
                }
                tbody.innerHTML += `<tr><td>${p} ${globalPrices[p] <= 0 ? 'üõ†Ô∏è' : ''}</td><td>${i.pT}</td><td>${i.vT}</td><td>${i.cT}</td><td>${i.rT}</td><td><b>${enMain}</b></td></tr>`;
            }
        }

        document.getElementById('btnConfirmerVente').addEventListener('click', async () => {
            const btn = document.getElementById('btnConfirmerVente');
            const name = valVendeur.value;
            const date = document.getElementById('valDate').value;
            const aco = parseFloat(document.getElementById('valAcompte').value) || 0;
            const rem = parseFloat(document.getElementById('valRemise').value) || 0;

            if (!name || !date) return alert("Choisissez un vendeur et une date.");
            if (sessionVentes.length === 0 && sessionConsos.length === 0 && sessionRetours.length === 0 && aco === 0 && rem === 0) return alert("Aucune donn√©e saisie.");

            btn.disabled = true;
            try {
                // 1. Enregistrement des Ventes
                for (let v of sessionVentes) {
                    await db.collection("ventes").add({ date, vendeur: name, produit: v.p, quantite: v.q, prixUnitaire: v.pu, total: v.t, payeAbidjan: valPayAbidjan.checked, abidjanRegle: false, clientRef: valClientRef.value, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                }
                // 2. Enregistrement des Consos
                for (let c of sessionConsos) {
                    await db.collection("consommations").add({ date, vendeur: name, produit: c.p, quantite: c.q, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                }
                // 3. Enregistrement des Retours
                for (let r of sessionRetours) {
                    await db.collection("retours_vendeurs").add({ date, vendeur: name, produit: r.p, quantite: r.q, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                }
                // 4. Enregistrement Argent
                if (aco > 0 || rem > 0) {
                    await db.collection("encaissements_vendeurs").add({ date, vendeur: name, montantRecu: aco, remise: rem, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                }

                alert("Tout a √©t√© enregistr√© avec succ√®s !");
                sessionVentes = []; sessionConsos = []; sessionRetours = [];
                document.getElementById('valAcompte').value = "";
                renderLists(); loadSellerData();
            } catch (e) { alert("Erreur."); } finally { btn.disabled = false; }
        });

        valPayAbidjan.addEventListener('change', (e) => { valClientRef.style.display = e.target.checked ? 'block' : 'none'; });
        valVendeur.addEventListener('change', loadSellerData);
        document.getElementById('valProduit').addEventListener('change', () => {
            valPrixUnit.value = globalPrices[document.getElementById('valProduit').value] || 0;
            const it = inventoryData[document.getElementById('valProduit').value];
            document.getElementById('sellerStockInfo').innerText = `En main : ${it ? it.pT - it.vT - it.rT - it.cT : 0}`;
        });

        document.getElementById('valDate').value = new Date().toISOString().split('T')[0];
        db.collection("users").orderBy("nom", "asc").get().then(snap => {
            valVendeur.innerHTML = '<option value="">-- Choisir un compte --</option>';
            snap.forEach(doc => { valVendeur.innerHTML += `<option value="${doc.data().nom}">${doc.data().nom}</option>`; });
        });
        loadPrices();
    </script>
</body>
</html>