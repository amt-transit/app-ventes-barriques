<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation des Ventes - AMT</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="logo.png">
    
</head>
<body>
    <header class="app-header">
        <img src="logo.png" alt="Logo" class="app-logo">
        <h1>Validation & Encaissement</h1>
    </header>

    <nav class="navigation">
        <a href="validation.html" class="active">Validation</a>
        <a href="stock.html">Stock</a>
        <a href="dashboard.html">Tableau de Bord</a>
        <a href="tresorerie.html">Tr√©sorerie</a>
        <a href="history.html">Historique</a>
        <a href="utilisateurs.html">Utilisateurs</a>
        <a href="recuperation.html">R√©cup√©ration</a>
        <button onclick="logout()" class="logout-button">D√©connexion</button>
    </nav>

    <div class="dashboard-grid-2-col" style="padding: 15px;">
        <div class="form-section">
            <h2 style="color: #1877f2; font-size: 15px; margin-top:0;">üìù Saisie group√©e des donn√©es</h2>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <input type="date" id="valDate" style="padding:10px; width:100%; box-sizing:border-box;">
                <select id="valVendeur" style="padding:10px; width:100%;"></select>

                <div class="section-ventes">
                    <p style="font-size: 10px; font-weight: bold; color: #1877f2;">üì¶ √âTAPE 1 : VENTES CLIENTS</p>
                    <select id="valProduit" style="padding:10px; width:100%; margin-bottom:5px;"></select>
                    <div id="sellerStockInfo" style="font-size: 10px; color: #1877f2; font-weight: bold; margin-bottom:5px;"></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="valQuantite" placeholder="Qt√©">
                        <input type="number" id="valPrixUnit" placeholder="Prix" readonly style="background:#f1f5f9; padding:10px;">
                    </div>
                    <button class="btn-add-item" onclick="ajouterItem('ventes')">Ajouter Vente ‚ûï</button>
                    <div id="list-ventes" class="temp-list">
                        <table style="width:100%; font-size:10px; margin:0;">
                            <thead><tr style="background:#e0efff;"><th>Produit</th><th>Qt√©</th><th>Total</th><th></th></tr></thead>
                            <tbody id="body-ventes"></tbody>
                        </table>
                    </div>
                </div>

                <div class="section-consos">
                    <p style="font-size: 10px; font-weight: bold; color: #64748b;">üõ†Ô∏è √âTAPE 2 : USAGE INTERNE (FOURNITURES)</p>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                        <select id="valProduitConso" style="padding:10px;"></select>
                        <input type="number" id="valQuantiteConso" placeholder="Qt√©">
                    </div>
                    <button class="btn-add-item" onclick="ajouterItem('consos')">Ajouter Usage ‚ûï</button>
                    <div id="list-consos" class="temp-list">
                        <table style="width:100%; font-size:10px; margin:0;">
                            <thead><tr style="background:#f1f5f9;"><th>Fourniture</th><th>Qt√©</th><th></th></tr></thead>
                            <tbody id="body-consos"></tbody>
                        </table>
                    </div>
                </div>

                <div class="section-retours">
                    <p style="font-size: 10px; font-weight: bold; color: #1e293b;">üîÑ √âTAPE 3 : RETOURS DE COLIS</p>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                        <select id="valProduitRetour" style="padding:10px;"></select>
                        <input type="number" id="valQuantiteRetour" placeholder="Qt√©">
                    </div>
                    <button class="btn-add-item" onclick="ajouterItem('retours')">Ajouter Retour ‚ûï</button>
                    <div id="list-retours" class="temp-list">
                        <table style="width:100%; font-size:10px; margin:0;">
                            <thead><tr style="background:#fff7ed;"><th>Produit</th><th>Qt√©</th><th></th></tr></thead>
                            <tbody id="body-retours"></tbody>
                        </table>
                    </div>
                </div>

                <div style="background: #f0fdf4; padding: 10px; border-radius: 8px; border: 1px solid #bbf7d0;">
                    <p style="font-size: 10px; font-weight: bold; color: #166534; margin: 0 0 5px 0;">üí∞ √âTAPE 4 : ARGENT RE√áU</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px;">
                        <input type="number" id="valAcompte" placeholder="Cash (‚Ç¨)" style="padding:10px;">
                        <input type="number" id="valCB" placeholder="CB (‚Ç¨)" style="padding:10px; border: 1px solid #6366f1;">
                        <input type="number" id="valRemise" placeholder="Remise (‚Ç¨)" style="padding:10px; border: 1px solid #fb923c;">
                    </div>
                </div>

                <div style="background: #fdf4ff; padding: 10px; border-radius: 8px; border: 1px solid #f5d0fe;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="valPayAbidjan" style="width: 18px; height: 18px; cursor: pointer;">
                        <label style="font-size: 12px; font-weight:bold;">Pay√© √† Abidjan</label>
                    </div>
                    <input type="text" id="valClientRef" placeholder="Nom/R√©f√©rence Client" style="display:none; width:100%; padding:10px; margin-top:5px; border-radius:5px; border:1px solid #f5d0fe;">
                </div>

                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="annulerTout()" class="btn-cancel-all">ANNULER TOUT</button>
                    <button id="btnConfirmerVente" class="btn-save-all">ENREGISTRER LA SESSION</button>
                </div>
            </div>
        </div>

        <div>
            <div class="kpi-stock-grid">
                <div class="card-stock bg-blue"><span class="stock-label">Vendu Agence</span><span id="totalDu" class="stock-number">0‚Ç¨</span></div>
                <div class="card-stock" style="background: #701a75;"><span class="stock-label">Vendu Abidjan</span><span id="totalVenduAbidjan" class="stock-number">0‚Ç¨</span></div>
                <div class="card-stock bg-green"><span class="stock-label">Total Cash</span><span id="totalPayeCash" class="stock-number">0‚Ç¨</span></div>
                <div class="card-stock" style="background: #6366f1;"><span class="stock-label">Total CB</span><span id="totalPayeCB" class="stock-number">0‚Ç¨</span></div>
                <div class="card-stock" style="background: #f59e0b;"><span class="stock-label">Remises (Mois)</span><span id="totalRemiseMois" class="stock-number">0‚Ç¨</span></div>
                <div class="card-stock bg-red"><span class="stock-label">Dette Vendeur</span><span id="resteAPayer" class="stock-number">0‚Ç¨</span></div>
            </div>
            <div class="table-responsive">
                <table id="sellerInventoryTable">
                    <thead><tr style="background: #f1f5f9;"><th>Produit</th><th>Pris</th><th>Vendu</th><th>üõ†Ô∏è Conso.</th><th>Rendu</th><th>En main</th></tr></thead>
                    <tbody id="sellerInventoryBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCV8hR9MxIdpZDthtQpMbByZtNet1nIO-M", authDomain: "app-ventes-barriques.firebaseapp.com", projectId: "app-ventes-barriques", storageBucket: "app-ventes-barriques.appspot.com", messagingSenderId: "615546459847", appId: "1:615546459847:web:1b387b0b703b7a9a1210e2" };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        window.db = firebase.firestore();
    </script>
    <script src="auth-guard.js"></script>

    <script>
        const valVendeur = document.getElementById('valVendeur');
        const valPayAbidjan = document.getElementById('valPayAbidjan');
        const valClientRef = document.getElementById('valClientRef');
        
        let inventoryData = {}; 
        let globalPrices = {};
        
        let sessionVentes = [];
        let sessionConsos = [];
        let sessionRetours = [];

        function formatEUR(n) { return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(n || 0); }

        // --- GESTION DU PANIER ---
        function ajouterItem(type) {
            let prod, qty, pu = 0;
            if (type === 'ventes') {
                prod = document.getElementById('valProduit').value;
                qty = parseInt(document.getElementById('valQuantite').value);
                pu = parseFloat(document.getElementById('valPrixUnit').value);
            } else if (type === 'consos') {
                prod = document.getElementById('valProduitConso').value;
                qty = parseInt(document.getElementById('valQuantiteConso').value);
            } else {
                prod = document.getElementById('valProduitRetour').value;
                qty = parseInt(document.getElementById('valQuantiteRetour').value);
            }

            if (!prod || isNaN(qty) || qty <= 0) return alert("Saisie invalide.");

            const it = inventoryData[prod];
            const enMain = it ? it.pT - it.vT - it.rT - it.cT : 0;
            const dejaDansPanier = (sessionVentes.filter(v => v.p === prod).reduce((s,v)=>s+v.q,0)) + 
                                (sessionConsos.filter(c => c.p === prod).reduce((s,c)=>s+c.q,0)) + 
                                (sessionRetours.filter(r => r.p === prod).reduce((s,r)=>s+r.q,0));

            if ((qty + dejaDansPanier) > enMain) return alert(`Action impossible. Stock insuffisant.`);

            if (type === 'ventes') sessionVentes.push({ p: prod, q: qty, pu: pu, t: qty * pu });
            else if (type === 'consos') sessionConsos.push({ p: prod, q: qty });
            else sessionRetours.push({ p: prod, q: qty });

            document.querySelectorAll('input[type="number"]').forEach(i => { if(i.id.includes('Quantite')) i.value = ""; });
            renderLists();
        }

        function renderLists() {
            const bV = document.getElementById('body-ventes'); bV.innerHTML = "";
            document.getElementById('list-ventes').style.display = sessionVentes.length > 0 ? "block" : "none";
            sessionVentes.forEach((v, i) => { bV.innerHTML += `<tr><td>${v.p}</td><td>${v.q}</td><td>${v.t}‚Ç¨</td><td><button class="btn-remove" onclick="supprSession('ventes', ${i})">‚ùå</button></td></tr>`; });

            const bC = document.getElementById('body-consos'); bC.innerHTML = "";
            document.getElementById('list-consos').style.display = sessionConsos.length > 0 ? "block" : "none";
            sessionConsos.forEach((c, i) => { bC.innerHTML += `<tr><td>${c.p}</td><td>${c.q}</td><td><button class="btn-remove" onclick="supprSession('consos', ${i})">‚ùå</button></td></tr>`; });

            const bR = document.getElementById('body-retours'); bR.innerHTML = "";
            document.getElementById('list-retours').style.display = sessionRetours.length > 0 ? "block" : "none";
            sessionRetours.forEach((r, i) => { bR.innerHTML += `<tr><td>${r.p}</td><td>${r.q}</td><td><button class="btn-remove" onclick="supprSession('retours', ${i})">‚ùå</button></td></tr>`; });
        }

        window.supprSession = (type, index) => {
            if (type === 'ventes') sessionVentes.splice(index, 1);
            else if (type === 'consos') sessionConsos.splice(index, 1);
            else sessionRetours.splice(index, 1);
            renderLists();
        };

        window.annulerTout = () => {
            if (confirm("Voulez-vous vider toutes les listes en cours ?")) {
                sessionVentes = []; sessionConsos = []; sessionRetours = [];
                resetFormFields();
                renderLists();
            }
        };

        function resetFormFields() {
            document.getElementById('valQuantite').value = "";
            document.getElementById('valQuantiteConso').value = "";
            document.getElementById('valQuantiteRetour').value = "";
            document.getElementById('valAcompte').value = "";
            document.getElementById('valRemise').value = ""; // Placeholder "Remise (‚Ç¨)" redeviendra visible
            document.getElementById('valClientRef').value = "";
            document.getElementById('valClientRef').style.display = "none";
            document.getElementById('valPayAbidjan').checked = false;
            document.getElementById('valProduit').value = "";
            document.getElementById('valProduitConso').value = "";
            document.getElementById('valProduitRetour').value = "";
            document.getElementById('sellerStockInfo').innerText = "";
        }

        // --- ENREGISTREMENT S√âCURIS√â (BATCH) ---
        document.getElementById('btnConfirmerVente').addEventListener('click', async () => {
            const btn = document.getElementById('btnConfirmerVente');
            const name = valVendeur.value;
            const date = document.getElementById('valDate').value;

            // --- S√âCURIT√â : AJOUT AUTOMATIQUE SI OUBLI DANS N'IMPORTE QUELLE SECTION ---
            
            // 1. Pour les Ventes
            const vProd = document.getElementById('valProduit').value;
            const vQty = parseInt(document.getElementById('valQuantite').value);
            if (vProd && vQty > 0 && sessionVentes.length === 0) {
                ajouterItem('ventes'); 
            }

            // 2. Pour l'Usage Interne (Consos)
            const cProd = document.getElementById('valProduitConso').value;
            const cQty = parseInt(document.getElementById('valQuantiteConso').value);
            if (cProd && cQty > 0 && sessionConsos.length === 0) {
                ajouterItem('consos');
            }

            // 3. Pour les Retours
            const rProd = document.getElementById('valProduitRetour').value;
            const rQty = parseInt(document.getElementById('valQuantiteRetour').value);
            if (rProd && rQty > 0 && sessionRetours.length === 0) {
                ajouterItem('retours');
            }

            const aco = parseFloat(document.getElementById('valAcompte').value) || 0;
            const cb = parseFloat(document.getElementById('valCB').value) || 0;
            const rem = parseFloat(document.getElementById('valRemise').value) || 0;

            if (!name || !date) return alert("Choisissez un vendeur et une date.");
            
            if (sessionVentes.length === 0 && sessionConsos.length === 0 && sessionRetours.length === 0 && aco === 0 && cb === 0 && rem === 0) return alert("Aucune donn√©e saisie.");

            // Calcul des totaux pour le r√©capitulatif
            const totalVentes = sessionVentes.reduce((sum, v) => sum + v.q, 0);
            const totalConsos = sessionConsos.reduce((sum, c) => sum + c.q, 0);
            const totalRetours = sessionRetours.reduce((sum, r) => sum + r.q, 0);

            // R√©capitulatif avec CB
            const recapMessage = `R√âCAPITULATIF :\n- Cash : ${formatEUR(aco)}\n- CB : ${formatEUR(cb)}\n- Remise : ${formatEUR(rem)}\nConfirmez-vous ?`;
            if (!confirm(recapMessage)) return;

            btn.disabled = true;
            
            // Utilisation d'un Batch pour garantir l'atomicit√©
            const batch = db.batch();

            try {
                // 1. Pr√©paration des Ventes
                sessionVentes.forEach(v => {
                    const ref = db.collection("ventes").doc();
                    batch.set(ref, { date, vendeur: name, produit: v.p, quantite: v.q, prixUnitaire: v.pu, total: v.t, payeAbidjan: valPayAbidjan.checked, abidjanRegle: false, clientRef: valClientRef.value, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                });

                // 2. Pr√©paration des Consos
                sessionConsos.forEach(c => {
                    const ref = db.collection("consommations").doc();
                    batch.set(ref, { date, vendeur: name, produit: c.p, quantite: c.q, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                });

                // 3. Pr√©paration des Retours
                sessionRetours.forEach(r => {
                    const ref = db.collection("retours_vendeurs").doc();
                    batch.set(ref, { date, vendeur: name, produit: r.p, quantite: r.q, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                });

                // 4. Pr√©paration de l'Argent (Paiement)
                if (aco > 0 || cb > 0 || rem > 0) {
                    const ref = db.collection("encaissements_vendeurs").doc();
                    batch.set(ref, { 
                        date, 
                        vendeur: name, 
                        montantRecu: aco, 
                        montantCB: cb, // Nouveau champ
                        remise: rem, 
                        timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                }

                // Ex√©cution atomique de tout le paquet
                await batch.commit();

                alert("Session enregistr√©e avec succ√®s !");
                sessionVentes = []; sessionConsos = []; sessionRetours = [];
                resetFormFields();
                renderLists(); 
                loadSellerData();

            } catch (e) {
                console.error("Erreur d'enregistrement:", e);
                alert("Une erreur est survenue. Rien n'a √©t√© enregistr√©.");
            } finally {
                btn.disabled = false;
            }
        });

        // --- CHARGEMENT DONN√âES FIRESTORE ---
        async function loadPrices() {
            const snap = await db.collection("stocks").get();
            snap.forEach(doc => { if (doc.data().produit) globalPrices[doc.data().produit] = parseFloat(doc.data().prixVente) || 0; });
        }

        async function loadSellerData() {
            const name = valVendeur.value; if (!name) return;
            const currentMonth = new Date().toISOString().slice(0, 7); // Format "2026-01"
            const [rSnap, vSnap, eSnap, retSnap, cSnap] = await Promise.all([
                db.collection("recuperations").where("vendeur", "==", name).get(),
                db.collection("ventes").where("vendeur", "==", name).get(),
                db.collection("encaissements_vendeurs").where("vendeur", "==", name).get(),
                db.collection("retours_vendeurs").where("vendeur", "==", name).get(),
                db.collection("consommations").where("vendeur", "==", name).get()
            ]);
            inventoryData = {};
            let hVenduAg = 0, hVenduAbi = 0, hRegleCash = 0, hRegleCB = 0, hRemiseMois = 0, hRemiseTotal = 0;
            rSnap.forEach(doc => { 
                const d = doc.data(); 
                if (d.statut === "confirme" || !d.statut) {
                    if (!inventoryData[d.produit]) inventoryData[d.produit] = { pT:0, vT:0, rT:0, cT:0 }; 
                    inventoryData[d.produit].pT += d.quantite; 
                }
            });
            vSnap.forEach(doc => {
                const d = doc.data();
                if (!inventoryData[d.produit]) inventoryData[d.produit] = { pT:0, vT:0, rT:0, cT:0 }; 
                inventoryData[d.produit].vT += d.quantite;

                if (d.payeAbidjan === true) {
                    hVenduAbi += (parseFloat(d.total) || 0); // Cumul Abidjan
                } else {
                    hVenduAg += (parseFloat(d.total) || 0); // Cumul Agence (Dette)
                }
            });
            cSnap.forEach(doc => { const d = doc.data(); if (!inventoryData[d.produit]) inventoryData[d.produit] = { pT:0, vT:0, rT:0, cT:0 }; inventoryData[d.produit].cT += d.quantite; });
            retSnap.forEach(doc => { const d = doc.data(); if (!inventoryData[d.produit]) inventoryData[d.produit] = { pT:0, vT:0, rT:0, cT:0 }; inventoryData[d.produit].rT += d.quantite; });
            // Calcul des encaissements et remises
            eSnap.forEach(doc => {
                const d = doc.data();
                hRegleCash += (parseFloat(d.montantRecu) || 0);
                hRegleCB += (parseFloat(d.montantCB) || 0); // Nouveau
                hRemiseTotal += (parseFloat(d.remise) || 0);
                if (d.date && d.date.startsWith(currentMonth)) hRemiseMois += (parseFloat(d.remise) || 0);
            });

            document.getElementById('totalDu').innerText = formatEUR(hVenduAg);
            document.getElementById('totalVenduAbidjan').innerText = formatEUR(hVenduAbi);
            document.getElementById('totalPayeCash').innerText = formatEUR(hRegleCash);
            document.getElementById('totalPayeCB').innerText = formatEUR(hRegleCB); // Nouveau
            document.getElementById('totalRemiseMois').innerText = formatEUR(hRemiseMois);
            
            // La dette d√©duit d√©sormais le Cash ET la CB
            document.getElementById('resteAPayer').innerText = formatEUR(hVenduAg - (hRegleCash + hRegleCB + hRemiseTotal));
            renderUI();
        }

        function renderUI() {
            document.querySelectorAll('select[id^="valProduit"]').forEach(s => s.innerHTML = '<option value="">-- Choisir --</option>');
            for (const p in inventoryData) {
                const i = inventoryData[p]; const enMain = i.pT - i.vT - i.rT - i.cT;
                if (enMain > 0) {
                    const opt = `<option value="${p}">${p}</option>`;
                    document.getElementById('valProduit').innerHTML += opt;
                    document.getElementById('valProduitRetour').innerHTML += opt;
                    document.getElementById('valProduitConso').innerHTML += opt;
                }
            }
            const tbody = document.getElementById('sellerInventoryBody'); tbody.innerHTML = '';
            for (const p in inventoryData) {
                const i = inventoryData[p]; const enMain = i.pT - i.vT - i.rT - i.cT;
                tbody.innerHTML += `<tr><td>${p} ${globalPrices[p] <= 0 ? 'üõ†Ô∏è' : ''}</td><td>${i.pT}</td><td>${i.vT}</td><td>${i.cT}</td><td>${i.rT}</td><td><b>${enMain}</b></td></tr>`;
            }
        }

        valPayAbidjan.addEventListener('change', (e) => { valClientRef.style.display = e.target.checked ? 'block' : 'none'; });
        valVendeur.addEventListener('change', loadSellerData);
        document.getElementById('valProduit').addEventListener('change', () => {
            valPrixUnit.value = globalPrices[document.getElementById('valProduit').value] || 0;
            const it = inventoryData[document.getElementById('valProduit').value];
            document.getElementById('sellerStockInfo').innerText = `En main : ${it ? it.pT - it.vT - it.rT - it.cT : 0}`;
        });

        document.getElementById('valDate').value = new Date().toISOString().split('T')[0];
        db.collection("users").orderBy("nom", "asc").get().then(snap => {
            valVendeur.innerHTML = '<option value="">-- Choisir un compte --</option>';
            snap.forEach(doc => { valVendeur.innerHTML += `<option value="${doc.data().nom}">${doc.data().nom}</option>`; });
        });
        loadPrices();
    </script>
</body>
</html>