<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200">
    <title>Validation des Ventes (Admin) - AMT</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="logo.png">
</head>
<body>
    <header class="app-header">
        <img src="logo.png" alt="Logo" class="app-logo">
        <h1>Validation & Encaissent des Ventes</h1>
    </header>

    <nav class="navigation">
        <a href="validation.html" class="active">Validation</a>
        <a href="stock.html">Stock</a>
        <a href="dashboard.html">Tableau de Bord</a>
        <a href="history.html">Historique</a>
        <button onclick="logout()" class="logout-button">D√©connexion</button>
    </nav>

    <div class="dashboard-grid-2-col" style="padding: 15px;">
        
        <div class="dashboard-container" style="padding: 15px;">
            <h2 style="color: #1877f2;">üìù Valider une Vente</h2>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <input type="date" id="valDate">
                
                <select id="valVendeur">
                    <option value="">-- S√©lectionner le Vendeur --</option>
                    <option value="Abdoul">Abdoul</option>
                    <option value="Ali">Ali</option>
                    <option value="Cheick">Cheick</option>
                    <option value="Demba">Demba</option>
                    <option value="Zoum">Zoum</option>
                </select>

                <select id="valProduit">
                    <option value="">-- Choisir un produit r√©cup√©r√© --</option>
                </select>

                <div id="sellerStockInfo" style="font-size: 11px; text-align: center; color: #dc3545; font-weight: bold; min-height: 15px;"></div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 10px;">Quantit√© vendue :</label>
                        <input type="number" id="valQuantite" placeholder="Qt√©">
                    </div>
                    <div>
                        <label style="font-size: 10px;">Prix Unitaire (‚Ç¨) :</label>
                        <input type="number" id="valPrixUnit" placeholder="Prix" readonly style="background-color: #f0f0f0; cursor: not-allowed; border: 1px solid #ccc;">
                    </div>
                </div>

                <div id="lineTotalBox" style="background: #eef2ff; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #c3dafe; margin: 5px 0;">
                    <span style="font-size: 10px; color: #4338ca;">Montant total de cette vente :</span><br>
                    <strong id="valTotalSaisie" style="font-size: 16px; color: #1e40af;">0,00 ‚Ç¨</strong>
                </div>

                <hr style="margin: 10px 0; border: none; border-top: 1px solid #eee;">

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 10px;">Acompte re√ßu (‚Ç¨) :</label>
                        <input type="number" id="valAcompte" placeholder="Argent re√ßu" value="0">
                    </div>
                    <div>
                        <label style="font-size: 10px;">Remise (‚Ç¨) :</label>
                        <input type="number" id="valRemise" placeholder="R√©duction" value="0">
                    </div>
                </div>

                <button id="btnConfirmerVente" class="primary" style="margin-top: 10px;">Valider & Enregistrer la Vente</button>
                <p id="msgStatus" style="text-align:center; font-weight:bold; margin-top:10px;"></p>
            </div>
        </div>

        <div class="dashboard-container" style="padding: 15px;">
            <h2>üì¶ Colis en main & Retours</h2>
            <table id="sellerInventoryTable" style="font-size: 11px; margin-bottom: 20px;">
                <thead>
                    <tr style="background: #f1f1f1;">
                        <th>Produit</th>
                        <th>En main</th>
                    </tr>
                </thead>
                <tbody id="sellerInventoryBody"></tbody>
            </table>

            <div id="returnSection" style="background: #fff5f5; padding: 10px; border-radius: 4px; border: 1px solid #feb2b2;">
                <h3 style="font-size: 12px; color: #c53030; margin-bottom: 5px;">üîÑ Retourner des colis au stock</h3>
                <div style="display: flex; gap: 5px;">
                    <select id="returnProduit" style="flex: 2;"><option value="">-- Produit --</option></select>
                    <input type="number" id="returnQty" placeholder="Qt√©" style="flex: 1;">
                    <button id="btnReturn" style="background: #c53030; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCV8hR9MxIdpZDthtQpMbByZtNet1nIO-M",
            authDomain: "app-ventes-barriques.firebaseapp.com",
            projectId: "app-ventes-barriques",
            storageBucket: "app-ventes-barriques.appspot.com",
            messagingSenderId: "615546459847",
            appId: "1:615546459847:web:1b387b0b703b7a9a1210e2"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const valVendeur = document.getElementById('valVendeur');
        const valProduit = document.getElementById('valProduit');
        const valQuantite = document.getElementById('valQuantite');
        const valPrixUnit = document.getElementById('valPrixUnit');
        const valTotalSaisie = document.getElementById('valTotalSaisie');
        const returnProduit = document.getElementById('returnProduit');
        const sellerInventoryBody = document.getElementById('sellerInventoryBody');
        const sellerStockInfo = document.getElementById('sellerStockInfo');
        
        document.getElementById('valDate').valueAsDate = new Date();
        let sellerStock = {}; 
        let globalPrices = {}; 

        function formatEUR(n) {
            return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(n);
        }

        function updateLineTotal() {
            const qty = parseFloat(valQuantite.value) || 0;
            const price = parseFloat(valPrixUnit.value) || 0;
            const total = qty * price;
            valTotalSaisie.innerText = formatEUR(total);
        }

        async function loadPrices() {
            try {
                const snap = await db.collection("stocks").get();
                globalPrices = {}; 
                snap.forEach(doc => {
                    const data = doc.data();
                    // MODIFICATION : Utilisation de 'prixVente' tel qu'affich√© dans votre Firebase
                    if (data.produit && data.prixVente) {
                        globalPrices[data.produit] = parseFloat(data.prixVente);
                    }
                });
            } catch (error) {
                console.error("Erreur chargement prix:", error);
            }
        }

        async function loadSellerData() {
            const name = valVendeur.value;
            if (!name) return;

            const [recupSnap, ventesSnap] = await Promise.all([
                db.collection("recuperations").where("vendeur", "==", name).get(),
                db.collection("ventes").where("vendeur", "==", name).get()
            ]);

            sellerStock = {};
            recupSnap.forEach(doc => {
                const d = doc.data();
                sellerStock[d.produit] = (sellerStock[d.produit] || 0) + d.quantite;
            });
            ventesSnap.forEach(doc => {
                const d = doc.data();
                sellerStock[d.produit] = (sellerStock[d.produit] || 0) - d.quantite;
            });

            valProduit.innerHTML = '<option value="">-- Choisir un produit r√©cup√©r√© --</option>';
            returnProduit.innerHTML = '<option value="">-- Produit --</option>';
            sellerInventoryBody.innerHTML = '';

            for (const prod in sellerStock) {
                const qty = sellerStock[prod];
                if (qty > 0) {
                    const opt = document.createElement('option');
                    opt.value = prod; opt.textContent = prod;
                    valProduit.appendChild(opt.cloneNode(true));
                    returnProduit.appendChild(opt);
                    sellerInventoryBody.innerHTML += `<tr><td>${prod}</td><td style="font-weight:bold; text-align:center;">${qty}</td></tr>`;
                }
            }
        }

        valVendeur.addEventListener('change', loadSellerData);

        valProduit.addEventListener('change', () => {
            const prod = valProduit.value;
            // R√©cup√©ration automatique du prix fixe
            const prix = globalPrices[prod] || 0;
            valPrixUnit.value = prix;
            
            sellerStockInfo.innerText = prod ? `Reste en main : ${sellerStock[prod] || 0} colis` : "";
            updateLineTotal();
        });

        valQuantite.addEventListener('input', updateLineTotal);

        document.getElementById('btnConfirmerVente').addEventListener('click', async () => {
            const qty = parseInt(valQuantite.value) || 0;
            const price = parseFloat(valPrixUnit.value) || 0;
            const acompte = parseFloat(document.getElementById('valAcompte').value) || 0;
            const remise = parseFloat(document.getElementById('valRemise').value) || 0;
            const prod = valProduit.value;

            if (!valVendeur.value || !prod || qty <= 0) return alert("Donn√©es incompl√®tes.");
            if (qty > (sellerStock[prod] || 0)) return alert("Le vendeur n'a pas assez de colis en main.");

            try {
                await db.collection("ventes").add({
                    date: document.getElementById('valDate').value,
                    vendeur: valVendeur.value,
                    produit: prod,
                    quantite: qty,
                    prixUnitaire: price,
                    total: qty * price,
                    modeDePaiement: acompte > 0 ? "Acompte" : "Valid√© Admin",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                if (acompte > 0 || remise > 0) {
                    await db.collection("encaissements_vendeurs").add({
                        date: document.getElementById('valDate').value,
                        vendeur: valVendeur.value,
                        montantRecu: acompte,
                        remise: remise,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                alert("Vente valid√©e et enregistr√©e !");
                location.reload();
            } catch (e) { alert("Erreur d'enregistrement."); }
        });

        document.getElementById('btnReturn').addEventListener('click', async () => {
            const qty = parseInt(document.getElementById('returnQty').value) || 0;
            const prod = returnProduit.value;
            if (!prod || qty <= 0) return;

            await db.collection("recuperations").add({
                date: document.getElementById('valDate').value,
                vendeur: valVendeur.value,
                produit: prod,
                quantite: -qty,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert("Retour au stock effectu√©.");
            loadSellerData();
        });

        loadPrices();
    </script>
</body>
</html>