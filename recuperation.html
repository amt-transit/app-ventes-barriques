<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retrait de Stock - AMT</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body.login-page { display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; background: #f0f2f5; font-family: 'Comfortaa', sans-serif; }
        .navigation { width: 100%; display: flex; justify-content: center; padding: 15px 0; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tab-nav { display: flex; gap: 10px; margin: 20px 0; }
        .tab-btn { padding: 10px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; background: #e2e8f0; transition: 0.3s; }
        .tab-btn.active { background: #1877f2; color: white; }
        .section-content { display: none; width: 100%; max-width: 550px; }
        .section-content.active { display: block; }
        .login-form { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box; }
        
        /* Tableaux et Cartes */
        .points-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .points-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        .points-table th, .points-table td { border-bottom: 1px solid #eee; padding: 12px; text-align: center; }
        .clickable-row { cursor: pointer; transition: background 0.2s; }
        .clickable-row:hover { background: #f1f5f9; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 20px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 70vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-modal { float: right; font-size: 24px; font-weight: bold; cursor: pointer; }

        .balance-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-item { padding: 10px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 16px; font-weight: bold; display: block; }
        .btn-pdf { background: #1e293b; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; cursor: pointer; margin-top: 5px; font-weight: bold; }
        /* Style sp√©cifique pour le badge de notification */
        .notification-badge {
            background-color: #be123c;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            margin-left: 5px;
            display: none; /* Cach√© par d√©faut */
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="login-page">

    <nav class="navigation">
        <a href="recuperation.html" class="active">R√©cup√©ration</a>
        <a href="validation.html" id="adminLink" style="display: none; background: #4b5563; color: white;">Administration</a>
        <button onclick="logout()" class="logout-button">D√©connexion</button>
    </nav>

    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchRecupTab('saisie')">Saisie Retrait</button>
        <button class="tab-btn" onclick="switchRecupTab('points')">Mes Points</button>
        <button id="tabBtnConfirm" class="tab-btn" onclick="switchRecupTab('confirmations')" style="display:none; background:#701a75; color:white;">
            üîî Confirmations <span id="notifCount" class="notification-badge">0</span>
        </button>
    </div>

    <div id="section-saisie" class="section-content active">
        <div class="login-form">
            <header style="text-align:center; margin-bottom:20px;">
                <img src="logo.png" alt="Logo" style="width:50px;">
                <h1 style="font-size:16px;">Nouvelle R√©cup√©ration</h1>
            </header>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <input type="date" id="recupDate">
                <select id="recupVendeur" disabled><option value="">Chargement...</option></select>
                <select id="recupProduit"><option value="">-- S√©lectionner le Produit --</option></select>
                <div id="stockInfo" style="font-size: 11px; text-align: center; color: #1877f2; font-weight: bold;"></div>
                <input type="number" id="recupQuantite" placeholder="Nombre de colis">
                <button id="btnValiderRecup" style="width: 100%; padding: 12px; background:#1877f2; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Valider le retrait</button>
                <p id="msgStatus" style="text-align:center; font-weight:bold; margin-top:10px;"></p>
            </div>
        </div>
    </div>

    <div id="section-points" class="section-content">
        <div class="points-card" style="display: flex; gap: 10px; justify-content: center; align-items: center; padding: 10px; background: white; border-radius: 12px;">
            <div style="display: flex; flex-direction: column;">
                <label style="font-size: 10px; font-weight: bold; color: #64748b;">Du</label>
                <input type="date" id="filterDateDebut" style="padding: 5px; border-radius: 5px; border: 1px solid #cbd5e1;">
            </div>
            <div style="display: flex; flex-direction: column;">
                <label style="font-size: 10px; font-weight: bold; color: #64748b;">Au</label>
                <input type="date" id="filterDateFin" style="padding: 5px; border-radius: 5px; border: 1px solid #cbd5e1;">
            </div>
            <button onclick="loadSellerPersonalPoints(currentSellerName)" style="margin-top: 15px; background: #1877f2; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer;">üîç</button>
        </div>

        <div id="printableArea">
            <div class="points-card" style="background: white; padding: 15px; border-radius: 12px; margin-top: 10px;">
                <h2 style="font-size: 14px; text-align: center; margin-bottom: 10px;">Point de situation : <span id="sellerDisplayName">...</span></h2>
                <div class="balance-box" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="stat-item" style="background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center;">
                        <span style="font-size:9px; font-weight: bold;">Vendu (‚Ç¨)</span>
                        <span id="myTotalVendu" class="stat-val" style="font-size: 16px; font-weight: bold; display: block;">0,00 ‚Ç¨</span>
                    </div>
                    <div class="stat-item" style="background: #f0fdf4; padding: 10px; border-radius: 8px; text-align: center;">
                        <span style="font-size:9px; font-weight: bold;">Vers√© (‚Ç¨)</span>
                        <span id="myTotalVerse" class="stat-val" style="color:#10b981; font-size: 16px; font-weight: bold; display: block;">0,00 ‚Ç¨</span>
                    </div>
                    <div class="stat-item" style="grid-column: span 2; background: #fff1f2; padding: 10px; border-radius: 8px; text-align: center;">
                        <span style="font-size:10px; font-weight:bold; color:#be123c;">Reste √† payer</span>
                        <span id="myReste" class="stat-val" style="color:#be123c; font-size:20px; font-weight: bold; display: block;">0,00 ‚Ç¨</span>
                    </div>
                </div>
            </div>

            <div class="points-card" style="background: white; padding: 15px; border-radius: 12px; margin-top: 10px;">
                <h3 style="margin:0; font-size:13px; color:#1e293b;">üì¶ Suivi des Colis (Cliquer pour le d√©tail)</h3>
                <div class="table-responsive">
                    <table class="points-table">
                        <thead>
                            <tr>
                                <th style="text-align:left;">Produit</th>
                                <th>Pris (Confirm√©)</th>
                                <th>Vendus</th>
                                <th style="color:#1877f2;">En Main</th>
                            </tr>
                        </thead>
                        <tbody id="myStockBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <button onclick="downloadPDF()" class="btn-pdf">üìÑ T√©l√©charger mon point (PDF)</button>
    </div>

    <div id="section-confirmations" class="section-content">
        <div class="points-card" style="background: white; padding: 15px; border-radius: 12px;">
            <h2 style="font-size: 15px; color: #701a75;">üìã Retraits en attente de confirmation</h2>
            <div class="table-responsive">
                <table class="points-table">
                    <thead>
                        <tr>
                            <th>Vendeur</th>
                            <th>Produit</th>
                            <th>Qt√©</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="adminConfirmBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeHistoryModal()">&times;</span>
            <h2 id="modalProductName" style="font-size: 15px; color: #1877f2; margin-top: 0; margin-bottom:15px;">D√©tail Produit</h2>
            <table class="points-table" style="width:100%;">
                <thead>
                    <tr><th>Date</th><th>Op√©ration</th><th>Quantit√©</th></tr>
                </thead>
                <tbody id="modalHistoryBody"></tbody>
            </table>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyCV8hR9MxIdpZDthtQpMbByZtNet1nIO-M", authDomain: "app-ventes-barriques.firebaseapp.com", projectId: "app-ventes-barriques", storageBucket: "app-ventes-barriques.appspot.com", messagingSenderId: "615546459847", appId: "1:615546459847:web:1b387b0b703b7a9a1210e2" };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        window.db = firebase.firestore();
    </script>
    <script src="auth-guard.js"></script>

    <script>
        let currentSellerName = "";
        let userRole = "";
        let rawData = { recups: [], ventes: [] };
        let stockDisponibleMagasin = {};
        const recupProduitSelect = document.getElementById('recupProduit');

        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                const snap = await db.collection("users").where("email", "==", user.email).get();
                if (!snap.empty) {
                    const userData = snap.docs[0].data();
                    currentSellerName = userData.nom;
                    userRole = userData.role;
                    
                    document.getElementById('sellerDisplayName').innerText = currentSellerName;
                    document.getElementById('recupVendeur').innerHTML = `<option value="${currentSellerName}">${currentSellerName}</option>`;
                    
                    if (userRole === 'admin' || userRole === 'superadmin') {
                        document.getElementById('adminLink').style.display = 'inline-block';
                        document.getElementById('tabBtnConfirm').style.display = 'block';
                        startRealTimeConfirmations(); // Lancer l'√©couteur Admin
                    }
                    
                    setDatesSemaineEnCours();
                    loadStockMagasin();
                    loadSellerPersonalPoints(currentSellerName);
                }
            }
        });

        // √âCOUTEUR EN TEMPS R√âEL (Badge + Tableau)
        function startRealTimeConfirmations() {
            // On √©coute TOUTE la collection pour √™tre s√ªr de ne rien rater
            db.collection("recuperations").onSnapshot(snap => {
                const tbody = document.getElementById('adminConfirmBody');
                const badge = document.getElementById('notifCount');
                
                // On filtre manuellement pour trouver les nouveaux ET les anciens sans statut
                const pendingDocs = snap.docs.filter(doc => {
                    const data = doc.data();
                    return data.statut === "en_attente" || !data.statut; 
                });

                const count = pendingDocs.length;
                
                // Mise √† jour du badge
                if (count > 0) {
                    badge.innerText = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }

                // Mise √† jour du tableau
                if (tbody) {
                    tbody.innerHTML = '';
                    if (count === 0) {
                        tbody.innerHTML = '<tr><td colspan="4">Aucun retrait en attente.</td></tr>';
                        return;
                    }
                    
                    pendingDocs.forEach(doc => {
                        const d = doc.data();
                        tbody.innerHTML += `
                            <tr>
                                <td><b>${d.vendeur}</b></td>
                                <td>${d.produit}</td>
                                <td>${d.quantite}</td>
                                <td>
                                    <button onclick="validerRetrait('${doc.id}')" style="background:#10b981; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Confirmer ‚úÖ</button>
                                    <button onclick="annulerRetrait('${doc.id}')" style="background:#be123c; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; margin-left:5px;">Refuser ‚ùå</button>
                                </td>
                            </tr>`;
                    });
                }
            });
        }

        async function loadStockMagasin() {
            const [stocksSnap, recupSnap, retoursSnap, pertesSnap, consosSnap] = await Promise.all([
                db.collection("stocks").get(),
                db.collection("recuperations").get(),
                db.collection("retours_vendeurs").get(),
                db.collection("pertes").get(),
                db.collection("consommations").get()
            ]);
            const totals = {};
            stocksSnap.forEach(doc => {
                const d = doc.data();
                if (!totals[d.produit]) totals[d.produit] = { in: 0, out: 0 };
                totals[d.produit].in += (parseInt(d.quantite) || 0);
            });
            retoursSnap.forEach(doc => {
                const d = doc.data();
                if (totals[d.produit]) totals[d.produit].in += (parseInt(d.quantite) || 0);
            });
            recupSnap.forEach(doc => {
                const d = doc.data();
                if (totals[d.produit] && d.statut === "confirme") totals[d.produit].out += (parseInt(d.quantite) || 0);
            });
            pertesSnap.forEach(doc => {
                const d = doc.data();
                if (totals[d.produit]) totals[d.produit].out += (parseInt(d.quantite) || 0);
            });
            consosSnap.forEach(doc => {
                const d = doc.data();
                if (!d.vendeur || d.vendeur === "MAGASIN") {
                    if (totals[d.produit]) totals[d.produit].out += (parseInt(d.quantite) || 0);
                }
            });
            recupProduitSelect.innerHTML = '<option value="">-- S√©lectionner le Produit --</option>';
            for (const p in totals) {
                const reste = totals[p].in - totals[p].out;
                stockDisponibleMagasin[p] = reste;
                if (reste > 0) {
                    const opt = document.createElement('option');
                    opt.value = p; opt.textContent = `${p} (${reste} dispos au d√©p√¥t)`;
                    recupProduitSelect.appendChild(opt);
                }
            }
        }

        document.getElementById('btnValiderRecup').addEventListener('click', async () => {
            const btn = document.getElementById('btnValiderRecup');
            const produit = recupProduitSelect.value;
            const quantite = parseInt(document.getElementById('recupQuantite').value) || 0;
            const date = document.getElementById('recupDate').value;
            if (!produit || quantite <= 0 || !date) return alert("Champs invalides.");
            if (quantite > stockDisponibleMagasin[produit]) return alert("Stock insuffisant.");
            btn.disabled = true;
            try {
                await db.collection("recuperations").add({ date: date, vendeur: currentSellerName, produit: produit, quantite: quantite, statut: "en_attente", timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                alert("Demande envoy√©e !");
                document.getElementById('recupQuantite').value = "";
                loadStockMagasin();
            } catch (e) { alert("Erreur."); }
            finally { btn.disabled = false; }
        });

        window.validerRetrait = async (id) => {
            if(confirm("Confirmer ce retrait ?")) {
                await db.collection("recuperations").doc(id).update({ statut: "confirme" });
                alert("Valid√© !");
                loadStockMagasin();
            }
        };

        window.annulerRetrait = async (id) => {
            if(confirm("Supprimer cette demande ?")) await db.collection("recuperations").doc(id).delete();
        };

        async function loadSellerPersonalPoints(nom) {
            const dateDebut = document.getElementById('filterDateDebut').value;
            const dateFin = document.getElementById('filterDateFin').value;
            const [recupSnap, ventesSnap, encaissSnap, pricesSnap] = await Promise.all([
                db.collection("recuperations").where("vendeur", "==", nom).get(),
                db.collection("ventes").where("vendeur", "==", nom).get(),
                db.collection("encaissements_vendeurs").where("vendeur", "==", nom).get(),
                db.collection("stocks").get()
            ]);
            let pVenteMap = {};
            pricesSnap.forEach(doc => { pVenteMap[doc.data().produit] = parseFloat(doc.data().prixVente) || 0; });
            rawData.recups = recupSnap.docs.map(doc => doc.data()).filter(d => d.date >= dateDebut && d.date <= dateFin && d.statut === "confirme");
            rawData.ventes = ventesSnap.docs.map(doc => doc.data()).filter(d => d.date >= dateDebut && d.date <= dateFin);
            const encaiss = encaissSnap.docs.map(doc => doc.data()).filter(d => d.date >= dateDebut && d.date <= dateFin);
            let stats = {};
            rawData.recups.forEach(d => { if(!stats[d.produit]) stats[d.produit]={p:0,v:0}; stats[d.produit].p += d.quantite; });
            rawData.ventes.forEach(d => { if(!stats[d.produit]) stats[d.produit]={p:0,v:0}; stats[d.produit].v += d.quantite; });
            const tbody = document.getElementById('myStockBody');
            tbody.innerHTML = '';
            for(let p in stats) {
                tbody.innerHTML += `
                    <tr class="clickable-row" onclick="openHistoryModal('${p}')">
                        <td style="text-align:left;">${p} ${pVenteMap[p] <= 0 ? 'üõ†Ô∏è' : '‚ÑπÔ∏è'}</td>
                        <td>${stats[p].p}</td>
                        <td style="color:#ef4444;">${stats[p].v}</td>
                        <td style="font-weight:bold; color:#1877f2;">${stats[p].p - stats[p].v}</td>
                    </tr>`;
            }
            let totalVenduArgent = rawData.ventes.filter(d => pVenteMap[d.produit] > 0).reduce((s,d) => s + (parseFloat(d.total)||0), 0);
            let totalVerse = encaiss.reduce((s,d) => s + (parseFloat(d.montantRecu)||0) + (parseFloat(d.remise)||0), 0);
            const fmt = n => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(n);
            document.getElementById('myTotalVendu').innerText = fmt(totalVenduArgent);
            document.getElementById('myTotalVerse').innerText = fmt(totalVerse);
            document.getElementById('myReste').innerText = fmt(totalVenduArgent - totalVerse);
        }

        function switchRecupTab(type) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            if(type === 'confirmations') {
                document.getElementById('tabBtnConfirm').classList.add('active');
                document.getElementById('section-confirmations').classList.add('active');
            } else if(type === 'points') {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('section-points').classList.add('active');
            } else {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('section-saisie').classList.add('active');
            }
        }

        function setDatesSemaineEnCours() {
            const now = new Date();
            const start = new Date(now.setDate(now.getDate() - now.getDay() + 1)).toISOString().split('T')[0];
            const end = new Date(now.setDate(now.getDate() + 6)).toISOString().split('T')[0];
            document.getElementById('filterDateDebut').value = start;
            document.getElementById('filterDateFin').value = end;
            document.getElementById('recupDate').value = new Date().toISOString().split('T')[0];
        }

        function openHistoryModal(p) {
            document.getElementById('modalProductName').innerText = `D√©tail : ${p}`;
            const b = document.getElementById('modalHistoryBody'); b.innerHTML = '';
            let h = [];
            rawData.recups.filter(r => r.produit === p).forEach(r => h.push({d:r.date, t:'Retrait', q:r.quantite, c:'#1877f2'}));
            rawData.ventes.filter(v => v.produit === p).forEach(v => h.push({d:v.date, t:'Vente', q:v.quantite, c:'#ef4444'}));
            h.sort((a,b) => new Date(b.d) - new Date(a.d));
            h.forEach(x => { b.innerHTML += `<tr><td>${x.d}</td><td style="color:${x.c}; font-weight:bold;">${x.t}</td><td>${x.q}</td></tr>`; });
            document.getElementById('historyModal').style.display = 'block';
        }
        function closeHistoryModal() { document.getElementById('historyModal').style.display = 'none'; }
        function downloadPDF() { const e = document.getElementById('printableArea'); html2pdf().set({ margin: 10, filename: `Point_${currentSellerName}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { format: 'a4' } }).from(e).save(); }
    </script>
</body>
</html>