<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retrait de Stock - AMT</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="logo.png">
    <style>
        /* Correction du d√©calage : On force la navigation en haut et le contenu au centre */
        body.login-page {
            display: flex;
            flex-direction: column; /* Aligne le menu et le formulaire verticalement */
            justify-content: flex-start; /* Aligne le contenu vers le haut */
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .navigation {
            width: 100%; /* Le menu prend toute la largeur */
            display: flex;
            justify-content: center;
            padding: 15px 0;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .login-container {
            flex-grow: 1; /* Prend l'espace restant */
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .history-section { margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        .history-table th, .history-table td { border: 1px solid #eee; padding: 8px; text-align: left; }
        .history-table th { background: #f8fafc; }
    </style>
</head>
<body class="login-page">

    <nav class="navigation">
        <a href="recuperation.html" class="active">üì¶ R√©cup√©ration</a>
        <a href="validation.html" id="adminLink" style="background: #4b5563; color: white; margin: 0 10px; padding: 5px 15px; border-radius: 5px; text-decoration: none; display: none;">‚öôÔ∏è Administration</a>
        <button onclick="logout()" class="logout-button">D√©connexion</button>
    </nav>

    <div class="login-container">
        <div class="login-form">
            <header class="app-header">
                <img src="logo.png" alt="Logo" class="app-logo">
                <h1>Retrait de Stock</h1>
            </header>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <input type="date" id="recupDate">
                
                <select id="recupVendeur" disabled>
                    <option value="">-- Chargement identit√© --</option>
                </select>

                <select id="recupProduit">
                    <option value="">-- S√©lectionner le Produit --</option>
                </select>

                <div id="stockInfo" style="font-size: 11px; text-align: center; color: #1877f2; font-weight: bold; min-height: 15px;"></div>

                <input type="number" id="recupQuantite" placeholder="Nombre de colis">
                <button id="btnValiderRecup" class="primary" style="width: 100%; padding: 10px;">Confirmer le retrait</button>
                <p id="msgStatus" style="text-align:center; font-weight:bold; margin-top:10px;"></p>

                <div class="history-section">
                    <h3 style="font-size: 12px; color: #475569;">üìã Mes 5 derniers retraits</h3>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Produit</th>
                                <th>Qt√©</th>
                            </tr>
                        </thead>
                        <tbody id="personalHistoryBody">
                            <tr><td colspan="3" style="text-align:center;">Chargement...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCV8hR9MxIdpZDthtQpMbByZtNet1nIO-M",
            authDomain: "app-ventes-barriques.firebaseapp.com",
            projectId: "app-ventes-barriques",
            storageBucket: "app-ventes-barriques.appspot.com",
            messagingSenderId: "615546459847",
            appId: "1:615546459847:web:1b387b0b703b7a9a1210e2"
        };

        if (!firebase.apps.length) { 
            firebase.initializeApp(firebaseConfig); 
        }

        window.db = firebase.firestore();
        window.auth = firebase.auth();
    </script>
    
    <script src="auth-guard.js"></script>

    <script>
        const recupVendeur = document.getElementById('recupVendeur');
        const recupProduitSelect = document.getElementById('recupProduit');
        const personalHistoryBody = document.getElementById('personalHistoryBody');
        let stockDisponible = {};

        document.getElementById('recupDate').valueAsDate = new Date();

        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                const snap = await db.collection("users").where("email", "==", user.email).get();
                if (!snap.empty) {
                    const userData = snap.docs[0].data();
                    recupVendeur.innerHTML = `<option value="${userData.nom}">${userData.nom}</option>`;
                    loadPersonalHistory(userData.nom);
                }
            }
        });

        function loadPersonalHistory(nomVendeur) {
            db.collection("recuperations")
                .where("vendeur", "==", nomVendeur)
                .orderBy("timestamp", "desc")
                .limit(5)
                .onSnapshot(snap => {
                    personalHistoryBody.innerHTML = '';
                    if (snap.empty) {
                        personalHistoryBody.innerHTML = '<tr><td colspan="3">Aucun retrait enregistr√©.</td></tr>';
                        return;
                    }
                    snap.forEach(doc => {
                        const d = doc.data();
                        personalHistoryBody.innerHTML += `
                            <tr>
                                <td>${d.date}</td>
                                <td>${d.produit}</td>
                                <td style="font-weight:bold;">${d.quantite}</td>
                            </tr>`;
                    });
                }, error => {
                    console.error("Erreur historique:", error);
                });
        }

        async function loadStockData() {
            try {
                const [stocksSnap, ventesSnap, recupSnap] = await Promise.all([
                    db.collection("stocks").get(),
                    db.collection("ventes").get(),
                    db.collection("recuperations").get()
                ]);
                const totals = {};
                stocksSnap.forEach(doc => {
                    const d = doc.data();
                    if (!totals[d.produit]) totals[d.produit] = { in: 0, out: 0 };
                    totals[d.produit].in += (d.quantite || 0);
                });
                [...ventesSnap.docs, ...recupSnap.docs].forEach(doc => {
                    const d = doc.data();
                    if (totals[d.produit]) totals[d.produit].out += (d.quantite || 0);
                });
                recupProduitSelect.innerHTML = '<option value="">-- S√©lectionner le Produit --</option>';
                for (const p in totals) {
                    const reste = totals[p].in - totals[p].out;
                    stockDisponible[p] = reste;
                    if (reste > 0) {
                        const opt = document.createElement('option');
                        opt.value = p; opt.textContent = `${p} (${reste} dispos)`;
                        recupProduitSelect.appendChild(opt);
                    }
                }
            } catch (e) { console.error("Erreur stock:", e); }
        }

        recupProduitSelect.addEventListener('change', () => {
            const p = recupProduitSelect.value;
            document.getElementById('stockInfo').innerText = p ? `Maximum possible : ${stockDisponible[p]} colis` : "";
        });

        document.getElementById('btnValiderRecup').addEventListener('click', async () => {
            const btn = document.getElementById('btnValiderRecup');
            const produit = recupProduitSelect.value;
            const quantite = parseInt(document.getElementById('recupQuantite').value) || 0;
            const vendeur = recupVendeur.value;

            if (!vendeur || !produit || quantite <= 0) return alert("Saisie invalide.");
            if (quantite > stockDisponible[produit]) return alert("Stock insuffisant.");

            btn.disabled = true;
            try {
                await db.collection("recuperations").add({
                    date: document.getElementById('recupDate').value,
                    vendeur: vendeur, produit: produit, quantite: quantite,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('msgStatus').innerText = "‚úÖ Succ√®s !";
                document.getElementById('recupQuantite').value = "";
                loadStockData();
            } catch (e) { alert("Erreur."); }
            finally { btn.disabled = false; }
        });

        loadStockData();
    </script>
</body>
</html>